# 遇到过比较深刻的问题记录


## 运维侧

1. Centos dmz网络问题
   > 背景: 我们的IDC机房有自己的出口防火墙和固定的公网IP，内部的服务映射至公网之后外部访问公网服务没有问题，内部访问映射出去的公网服务就出现了问题，原因在于防火墙做了地址转换后，内网ng有一项内核参数没有调整好
   > 
   > 解决办法：就是禁用反向路径过滤，反向路径过滤是一种安全机制，用于验证接收到的数据包的源地址是否可通过接收接口到达。net.ipv4.conf.default.rp_filter=0 关闭之后解决了该问题

    `vim /etc/sysctl.conf`
    ```bash
    net.ipv4.ip_forward=1
    net.ipv4.conf.default.rp_filter=0     
    net.ipv4.conf.all.rp_filter=0
    ```

2. Elasticsearch从三节点变为六节点冷热集群架构设计

3. GPFS vfs fuse功能的实现
   > 背景：最开始设想的是如何让用户体验更好的基础上实现的vfs，访问一个文件，获取文件的元数据信息，这些信息存放在inode中，读取文件时判断文件是否具有指定的key value值，如果有的话就从对应的另一个存储中读文件，并将数据写入到buffer中，返回给gpfs客户端。
   > 
   > 踩坑一：直接修改gpfs客户端源码，从内核层面解决这个问题，最后发现压根拿不到文件偏移量等数据信息，可以在内核读取另一个存储的文件数据，但是没办法像原生的方法一样将数据返回给操作系统应用层应用，因为不知道该如何传这些数据量。
   > 
   > 踩坑二：首先把数据迁移到另一个存储是很容易实现的，通过GPFS内置的分层策略可以获取要迁移至第三方存储的文件列表，比如大于14天未访问的文件列表，将这些文件通过自定义脚本迁移至第三方存储中。迁移完需要创建一个跟源文件路径和文件名保持一致的空文件，这个空文件必须要满足一个条件就是执行ls -lh的时候可以查看该文件的大小，但是执行du -sh的时候显示为空数据（保证文件实际上不占用空间，只是inode占了一些空间），可以使用truncate命令创建稀疏文件，刚好满足需求。但是后来发现一个问题，软链接文件没法按照刚才所述的方式首先，读一个软链接文件会直接读取该软链接文件对应的目的文件，在vfs上是会直接返回目的文件路径，然后读取数据。
   > 
   > 最终方案：直接mount第三方存储，迁移完数据，创建一个跟第三方存储相关的软链接文件，后续哪台机器要访问数据，直接挂载第三方存储即可。

4. SeaweedFS的Ctime时间跟Mtime时间是保持一致的，没法判断哪些文件经过一段时间可以删除(我们存储上有一些数据保存一两年后是可以删除的)，所以没办法实现数据闭环。经过之前的经验，我们对fuse有了一定的了解，最后修改了seaweedfs的fuse相关的代码实现，实现Ctime在read文件时也会更新。

## 开发侧

1. docker ansible ssh执行playbook完会后会遗留下来一批僵尸进程不会被回收，持续一段时间之后产生内存泄漏问题，宿主机运行playboos后进程则会被init进程回收
    > https://blog.phusion.nl/2015/01/20/docker-and-the-pid-1-zombie-reaping-problem/

    当在Docker容器中运行Ansible时，僵尸进程问题产生的主要原因有：

- PID 1特殊性：在Docker容器中，启动的第一个进程（PID 1）拥有特殊的职责，包括回收子进程。
- 普通应用程序（如Python、Bash等）通常没有设计来处理PID 1的职责，尤其是处理SIGCHLD信号和回收子进程。
- 信号处理缺失：常规应用程序作为PID 1运行时，不会自动接收和处理SIGCHLD信号，这导致子进程在退出后变成僵尸进程，无法被回收。
    Ansible工作机制：Ansible在执行playbook时会创建多个子进程来并行执行任务，而这些子进程完成后需要被父进程正确回收。

2. cmdb开发过程中有一个远程虚拟机的tty的功能开发了很久，主要卡点在于如何实现远程虚拟机像跟在vSphere上远程效果一致的js资源，可以实现远程关机重启等功能，还有就是找到了资源如何远程虚拟机，是通过vSphere还是Esxi，虚拟机时分布在不同的Esxi节点上。最终通过一篇python实现的类似的功能的文章，参考了下改为golang实现。

3. 基于PXE的自动装机
    > 问题一：如何保证待装机的机器装机后网段归属至业务网，后续再次重启不会进入装机网
    > 
    > 解决：服务器上的网卡配置多vlan，交换机接口配置trunk，允许多vlan接入，装机之后会有初始化脚本，将服务器网卡ip修改为业务网段ip，保证下次重启不会进入装机网。
    > 
